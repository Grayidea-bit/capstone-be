# .github/workflows/auto_pr_review.yml
name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: AI Code Review
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr_number = pr.number;

            // é‡è¦ï¼šè«‹å°‡ YOUR_API_ENDPOINT æ›¿æ›æˆæ‚¨éƒ¨ç½²å¾Œæœå‹™çš„å…¬é–‹ç¶²å€
            const api_endpoint = `https://YOUR_API_ENDPOINT/pr/repos/${owner}/${repo}/pulls/${pr_number}`;
            
            // é‡è¦ï¼šè«‹å°‡æ‚¨çš„æœå‹™ Access Token è¨­å®šåœ¨ GitHub Repo çš„ Secrets ä¸­ï¼Œä¸¦å‘½åç‚º API_ACCESS_TOKEN
            const access_token = "${{ secrets.API_ACCESS_TOKEN }}";

            const url = `${api_endpoint}?access_token=${access_token}`;

            try {
              const response = await fetch(url, { method: 'GET' });
              const data = await response.json();

              if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${data.detail || ''}`);
              }
              
              const analysis = data.pull_request_analysis;
              const comment_body = `### ğŸ¤– AI Code Review å ±å‘Š\n\n${analysis}`;

              // ç™¼ä½ˆè©•è«–åˆ° PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr_number,
                body: comment_body,
              });

            } catch (error) {
              const error_comment = `### ğŸ¤– AI Code Review å¤±æ•—\n\nç„¡æ³•å®Œæˆè‡ªå‹•åŒ–ç¨‹å¼ç¢¼å¯©æŸ¥ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n\`\`\`\n${error.message}\n\`\`\``;
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr_number,
                body: error_comment,
              });
              // è®“ Action å¤±æ•—ä»¥æç¤ºéŒ¯èª¤
              core.setFailed(error.message);
            }